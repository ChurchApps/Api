service: api

frameworkVersion: "3"

custom:
  env: ${opt:stage, 'dev'}
  serverless-offline:
    httpPort: 8084
    websocketPort: 8087
    lambdaPort: 8085
  vpcSettings:
    prod:
      securityGroupIds:
        - sg-052314a1eec2f2567
      subnetIds:
        - subnet-01a6b61d749d10c46
    current: ${self:custom.vpcSettings.${self:custom.env}, self:custom.vpcSettings.prod}
  # Critical database connections loaded from Parameter Store at deploy time
  # These provide faster cold starts by avoiding runtime Parameter Store calls

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: us-east-2
  memorySize: 1024
  timeout: 30
  environment:
    STAGE: ${self:custom.env}
    ENVIRONMENT: ${self:custom.env}
  iam:
    role: arn:aws:iam::428019619026:role/ChurchAppsRole

package:
  individually: false
  patterns:
    - "config/**"
    - "dist/**"
    - "lambda.js"
    - "package.json"
    - "!node_modules/**"
    - "!src/**"
    - "!tools/**"
    - "!package-lock.json"
    - "!tsconfig.json"
    - "!.env"
    - "!.git/**"
    - "!.gitignore"
    - "!README.md"
    - "!serverless.yml"
    - "!layer/**"

layers:
  dependencies:
    path: layer
    name: ${self:service}-dependencies-${self:custom.env}
    description: Dependencies layer for ${self:service}
    compatibleRuntimes:
      - nodejs20.x
    retain: false

functions:
  web:
    handler: lambda.web
    layers:
      - { Ref: DependenciesLambdaLayer }
    memorySize: 512
    timeout: 30
    vpc: ${self:custom.vpcSettings.current}
    environment:
      # Load critical database connections from Parameter Store for faster cold starts
      # These will be used as fallbacks before Parameter Store batch calls
      MEMBERSHIP_CONNECTION_STRING: ${ssm:/${self:custom.env}/membershipApi/connectionString, ''}
      ATTENDANCE_CONNECTION_STRING: ${ssm:/${self:custom.env}/attendanceApi/connectionString, ''}
      CONTENT_CONNECTION_STRING: ${ssm:/${self:custom.env}/contentApi/connectionString, ''}
      GIVING_CONNECTION_STRING: ${ssm:/${self:custom.env}/givingApi/connectionString, ''}
      MESSAGING_CONNECTION_STRING: ${ssm:/${self:custom.env}/messagingApi/connectionString, ''}
      DOING_CONNECTION_STRING: ${ssm:/${self:custom.env}/doingApi/connectionString, ''}
    events:
      - http:
          path: /
          method: ANY
          cors: true
      - http:
          path: /{proxy+}
          method: ANY
          cors: true
      - http:
          path: /api/{proxy+}
          method: ANY
          cors: true

  socket:
    handler: lambda.socket
    layers:
      - { Ref: DependenciesLambdaLayer }
    memorySize: 1024
    timeout: 30
    vpc: ${self:custom.vpcSettings.current}
    environment:
      # Database connections for WebSocket functionality
      MEMBERSHIP_CONNECTION_STRING: ${ssm:/${self:custom.env}/membershipApi/connectionString, ''}
      MESSAGING_CONNECTION_STRING: ${ssm:/${self:custom.env}/messagingApi/connectionString, ''}
    events:
      - websocket:
          route: $connect
      - websocket:
          route: $disconnect
      - websocket:
          route: $default

  timer15Min:
    handler: lambda.timer15Min
    layers:
      - { Ref: DependenciesLambdaLayer }
    memorySize: 256
    timeout: 300
    vpc: ${self:custom.vpcSettings.current}
    environment:
      # Database connections for messaging notifications
      MEMBERSHIP_CONNECTION_STRING: ${ssm:/${self:custom.env}/membershipApi/connectionString, ''}
      MESSAGING_CONNECTION_STRING: ${ssm:/${self:custom.env}/messagingApi/connectionString, ''}
    events:
      - schedule:
          rate: rate(30 minutes)
          enabled: true

  timerMidnight:
    handler: lambda.timerMidnight
    layers:
      - { Ref: DependenciesLambdaLayer }
    memorySize: 256
    timeout: 300
    vpc: ${self:custom.vpcSettings.current}
    environment:
      # Database connections for daily digest notifications
      MEMBERSHIP_CONNECTION_STRING: ${ssm:/${self:custom.env}/membershipApi/connectionString, ''}
      MESSAGING_CONNECTION_STRING: ${ssm:/${self:custom.env}/messagingApi/connectionString, ''}
    events:
      - schedule:
          rate: cron(0 5 * * ? *)
          enabled: true

plugins:
  - serverless-offline

resources:
  Resources:
    GatewayResponseDefault4XX:
      Type: "AWS::ApiGateway::GatewayResponse"
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
        ResponseType: DEFAULT_4XX
        RestApiId:
          Ref: "ApiGatewayRestApi"

    GatewayResponseDefault5XX:
      Type: "AWS::ApiGateway::GatewayResponse"
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
        ResponseType: DEFAULT_5XX
        RestApiId:
          Ref: "ApiGatewayRestApi"
